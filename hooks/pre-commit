#!/bin/bash
#
# Pre-commit hook to prevent committing secrets and sensitive data
# This hook scans staged files for common secret patterns
#

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if we found any issues
FOUND_ISSUES=0

echo "üîç Scanning for secrets and sensitive data..."

# Exclude examples and hooks directories from scanning (safe template files)
STAGED_FILES=$(git diff --cached --name-only)
STAGED_CONTENT=$(git diff --cached)

# Filter out examples and hooks directories from content
# Also filter by file path to exclude entire files
FILTERED_FILES=$(echo "$STAGED_FILES" | grep -vE "^(examples|hooks)/" || echo "")
if [ -z "$FILTERED_FILES" ]; then
    # All files are in excluded directories, nothing to check
    FILTERED_CONTENT=""
else
    # Get content only for non-excluded files
    FILTERED_CONTENT=$(git diff --cached -- $(echo "$FILTERED_FILES") 2>/dev/null || echo "")
fi

# Check for AWS Access Keys (AKIA followed by 16 alphanumeric characters)
if echo "$FILTERED_CONTENT" | grep -E "AKIA[0-9A-Z]{16}" > /dev/null 2>&1; then
    echo -e "${RED}‚ùå ERROR: AWS Access Key detected!${NC}"
    echo "   Found pattern: AKIA[16 alphanumeric chars]"
    echo "   Please remove AWS credentials before committing."
    FOUND_ISSUES=1
fi

# Check for AWS Secret Keys (40+ character base64-like strings)
if echo "$FILTERED_CONTENT" | grep -E "[0-9a-zA-Z/+]{40,}" > /dev/null 2>&1; then
    # But exclude common false positives and example files
    if ! echo "$FILTERED_CONTENT" | grep -E "(sha256:|sha1:|commit|package-lock|YOUR-|example|placeholder)" > /dev/null 2>&1; then
        echo -e "${YELLOW}‚ö†Ô∏è  WARNING: Potential AWS Secret Key detected!${NC}"
        echo "   Found long alphanumeric string (40+ chars)"
        echo "   Please verify this is not a secret key."
        # Don't fail on this, just warn
    fi
fi

# Check for RSA/SSH Private Keys
if echo "$FILTERED_CONTENT" | grep -E "(BEGIN RSA PRIVATE KEY|BEGIN PRIVATE KEY|BEGIN OPENSSH PRIVATE KEY|-----BEGIN.*PRIVATE)" > /dev/null 2>&1; then
    echo -e "${RED}‚ùå ERROR: Private key detected!${NC}"
    echo "   Found pattern: BEGIN ... PRIVATE KEY"
    echo "   Please remove private keys before committing."
    echo "   Add key files to .gitignore instead."
    FOUND_ISSUES=1
fi

# Check for common password patterns
if echo "$FILTERED_CONTENT" | grep -iE "(password|passwd|pwd)\s*[:=]\s*['\"][^'\"]+['\"]" > /dev/null 2>&1; then
    echo -e "${RED}‚ùå ERROR: Hardcoded password detected!${NC}"
    echo "   Found pattern: password = '...' or password: '...'"
    echo "   Please use environment variables instead."
    FOUND_ISSUES=1
fi

# Check for API keys (common patterns)
if echo "$FILTERED_CONTENT" | grep -iE "(api[_-]?key|apikey)\s*[:=]\s*['\"][^'\"]+['\"]" > /dev/null 2>&1; then
    echo -e "${RED}‚ùå ERROR: API key detected!${NC}"
    echo "   Found pattern: api_key = '...' or apikey: '...'"
    echo "   Please use environment variables instead."
    FOUND_ISSUES=1
fi

# Check for key file extensions (excluding examples and hooks directories)
for file in $STAGED_FILES; do
    # Skip examples and hooks directories
    if echo "$file" | grep -E "^(examples|hooks)/" > /dev/null 2>&1; then
        continue
    fi
    # Check for key file extensions
    if echo "$file" | grep -E "\.(pem|key|p12|pfx|crt|cer|ppk)$" > /dev/null 2>&1; then
        echo -e "${RED}‚ùå ERROR: Key file detected: $file${NC}"
        echo "   Files with extensions .pem, .key, .p12, .pfx, .crt, .cer, .ppk should not be committed."
        echo "   Please add to .gitignore instead."
        FOUND_ISSUES=1
    fi
    
    # Check for credential file names
    if echo "$file" | grep -iE "(credential|secret|password|key).*\.(txt|json|yaml|yml|env|conf|config)$" > /dev/null 2>&1; then
        echo -e "${YELLOW}‚ö†Ô∏è  WARNING: Potential credential file: $file${NC}"
        echo "   Please verify this file does not contain sensitive data."
        # Don't fail, just warn
    fi
done

# Check for .env files (excluding examples and hooks directories)
if echo "$STAGED_FILES" | grep -vE "^(examples|hooks)/" | grep -E "\.env$|\.env\." > /dev/null 2>&1; then
    echo -e "${RED}‚ùå ERROR: .env file detected!${NC}"
    echo "   .env files should not be committed."
    echo "   Please add to .gitignore and use .env.example instead."
    FOUND_ISSUES=1
fi

# Summary
if [ $FOUND_ISSUES -eq 1 ]; then
    echo ""
    echo -e "${RED}========================================${NC}"
    echo -e "${RED}  COMMIT BLOCKED - Secrets Detected${NC}"
    echo -e "${RED}========================================${NC}"
    echo ""
    echo "Please:"
    echo "  1. Remove the secrets from your files"
    echo "  2. Use environment variables or config files (in .gitignore)"
    echo "  3. Add sensitive files to .gitignore"
    echo "  4. Try committing again"
    echo ""
    exit 1
else
    echo -e "${GREEN}‚úÖ No secrets detected. Proceeding with commit...${NC}"
    exit 0
fi

